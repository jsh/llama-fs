#!/bin/bash -eu
set -o pipefail

# this script is intended to succeed
# and to be idempotent

die() {
    # print error message and die
    echo "$*" || exit -1
}

verify_keys_exist() {
    # both variables need to be set
    # see instructions in README.md
    grep -q GROQ_API_KEY &&
        grep -q AGENTOPS_API_KEY
}

pyenv local 3                           # use the latest built python3 
python3 -m venv .venv                   # create a virtual environment
source .venv/bin/activate               # use it
python3 bin/check-python-version.py     # verify that the version is new enough
pip install --upgrade pip               # get the latest pip
pip install -r requirements.txt         # install the requirements
[ -f .env ] || cp .env.example .env     # create .env unless it already exists
cat .env | verify_keys_exist ||
    die ".env must set both GROQ_API_KEY and AGENTOPS_API_KEY"
